<launch>
  <!-- Top-level unified args -->
  <arg name="num_vehicles" default="3" />
  <arg name="enable_platooning" default="false" />

  <!-- Toggle BEV pipeline (inference + teleporter); also drives controller tracking hold -->
  <arg name="enable_bev_pipeline" default="true" />
  <!-- Waypoint-based yaw guarding -->
  <arg name="use_waypoint_heading_guard" default="false" />
  <arg name="waypoint_heading_window_deg" default="30.0" />
  <arg name="snap_to_spawn_heading" default="true" />
  <arg name="spawn_heading_max_distance_m" default="7.0" />
  <arg name="snap_to_spawn_pose_initial" default="true" />

  <!-- 초기 Carla 자세 정렬 설정 파라미터. true일 때, 초기 Carla 자세 정렬을 위해 초기 웨이포인트 사용. -->
  <!-- 초기 정렬에 웨이포인트만 사용하고싶다면, yaw_waypoint_weight를 1.0, yaw_path_weight를 0.0으로 설정. -->
  <arg name="yaw_blend_enabled" default="true" />
  <arg name="yaw_waypoint_weight" default="0.2" />
  <arg name="yaw_path_weight" default="0.3" />
  <arg name="yaw_stability_alpha" default="0.6" />
  <!-- Vehicle color hints (used for Hungarian matching assist) -->
  <arg name="vehicle_1_color" default="red" />
  <arg name="vehicle_2_color" default="purple" />
  <arg name="vehicle_3_color" default="pink" />
  <arg name="vehicle_4_color" default="" />
  <arg name="vehicle_5_color" default="" />
  <arg name="vehicle_6_color" default="" />
  <arg name="enable_color_matching" default="true" />
  <arg name="color_gate_on_mismatch" default="true" />
  <arg name="color_match_bonus" default="4.0" />
  <arg name="color_mismatch_penalty" default="15.0" />
  <arg name="color_missing_penalty" default="2.0" />
  <!-- Initial alignment parameters -->
  <arg name="enable_initial_alignment" default="true" />
  <arg name="initial_alignment_timeout_sec" default="6.0" />
  <arg name="initial_alignment_dist_gate_m" default="0.0" />
  <arg name="initial_alignment_yaw_gate_deg" default="0.0" />
  <arg name="initial_alignment_max_teleport_m" default="0.0" />
  <arg name="initial_alignment_teleport_yaw_gate_deg" default="0.0" />
  <arg name="initial_alignment_skip_warmup" default="true" />
  <arg name="initial_alignment_avg_duration_sec" default="1.0" />

  <!-- Inference (UDP) args -->
  <arg name="udp_ip" default="0.0.0.0" />
  <arg name="udp_ports" default="60200" />
  <arg name="bev_topic" default="/bev_info" />
  <arg name="input_yaw_degrees" default="true" />
  <arg name="x_offset_m" default="0.0" />
  <arg name="y_offset_m" default="2.0" />
  <arg name="yaw_add_deg" default="180.0" />
  <arg name="max_items" default="64" />

  <!-- 1) UDP inference receiver (publishes BEVInfo on /bev_info) -->
  <!-- <node if="$(arg enable_bev_pipeline)" pkg="carla_multi_vehicle_planner" type="inference_recv.py" name="inference_receiver" output="screen"> -->
    <!-- <param name="udp_ip" value="$(arg udp_ip)" />
    <param name="udp_ports" value="$(arg udp_ports)" />
    <param name="topic" value="$(arg bev_topic)" />
    <param name="input_yaw_degrees" value="$(arg input_yaw_degrees)" />
    <param name="x_offset_m" value="$(arg x_offset_m)" />
    <param name="y_offset_m" value="$(arg y_offset_m)" />
    <param name="yaw_add_deg" value="$(arg yaw_add_deg)" />
    <param name="max_items" value="$(arg max_items)" /> -->
  <!-- </node> -->

  <!-- 2) Teleporter: BEVInfo -> CARLA vehicle teleport (keep existing options via its own launch) -->
  <include if="$(arg enable_bev_pipeline)" file="$(find carla_multi_vehicle_planner)/launch/bev_id_teleporter.launch">
    <arg name="max_vehicle_count" value="$(arg num_vehicles)" />
    <arg name="enable_waypoint_heading_guard" value="$(arg use_waypoint_heading_guard)" />
    <arg name="waypoint_heading_window_deg" value="$(arg waypoint_heading_window_deg)" />
    <arg name="snap_to_spawn_heading" value="$(arg snap_to_spawn_heading)" />
    <arg name="spawn_heading_max_distance_m" value="$(arg spawn_heading_max_distance_m)" />
    <arg name="snap_to_spawn_pose_initial" value="$(arg snap_to_spawn_pose_initial)" />
    <arg name="yaw_blend_enabled" value="$(arg yaw_blend_enabled)" />
    <arg name="yaw_waypoint_weight" value="$(arg yaw_waypoint_weight)" />
    <arg name="yaw_path_weight" value="$(arg yaw_path_weight)" />
    <arg name="yaw_stability_alpha" value="$(arg yaw_stability_alpha)" />
    <arg name="vehicle_1_color" value="$(arg vehicle_1_color)" />
    <arg name="vehicle_2_color" value="$(arg vehicle_2_color)" />
    <arg name="vehicle_3_color" value="$(arg vehicle_3_color)" />
    <arg name="vehicle_4_color" value="$(arg vehicle_4_color)" />
    <arg name="vehicle_5_color" value="$(arg vehicle_5_color)" />
    <arg name="vehicle_6_color" value="$(arg vehicle_6_color)" />
    <arg name="enable_color_matching" value="$(arg enable_color_matching)" />
    <arg name="color_gate_on_mismatch" value="$(arg color_gate_on_mismatch)" />
    <arg name="color_match_bonus" value="$(arg color_match_bonus)" />
    <arg name="color_mismatch_penalty" value="$(arg color_mismatch_penalty)" />
    <arg name="color_missing_penalty" value="$(arg color_missing_penalty)" />
    <arg name="enable_initial_alignment" value="$(arg enable_initial_alignment)" />
    <arg name="initial_alignment_timeout_sec" value="$(arg initial_alignment_timeout_sec)" />
    <arg name="initial_alignment_dist_gate_m" value="$(arg initial_alignment_dist_gate_m)" />
    <arg name="initial_alignment_yaw_gate_deg" value="$(arg initial_alignment_yaw_gate_deg)" />
    <arg name="initial_alignment_max_teleport_m" value="$(arg initial_alignment_max_teleport_m)" />
    <arg name="initial_alignment_teleport_yaw_gate_deg" value="$(arg initial_alignment_teleport_yaw_gate_deg)" />
    <arg name="initial_alignment_skip_warmup" value="$(arg initial_alignment_skip_warmup)" />
    <arg name="initial_alignment_avg_duration_sec" value="$(arg initial_alignment_avg_duration_sec)" />
    <!-- Pass-through optional overrides:
         <arg name="topic" value="/bev_info" />
         <arg name="yaw_in_degrees" value="false" />
         <arg name="snap_to_waypoint_height" value="true" />
         <arg name="default_z" value="0.5" />
         <arg name="z_offset" value="0.0" />
         <arg name="carla_host" value="localhost" />
         <arg name="carla_port" value="2000" />
    -->
  </include>

  <!-- 3) Planner + Controller + Visualizers (keep all original args) -->
  <include file="$(find carla_multi_vehicle_planner)/launch/conflict_free_system.launch">
    <arg name="enable_platooning" value="$(arg enable_platooning)" />
    <arg name="num_vehicles" value="$(arg num_vehicles)" />
    <arg name="enable_manual_goal" default="false" />
    <!-- When BEV pipeline disabled, also disable controller's tracking hold -->
    <arg name="enable_bev_tracking_hold" value="$(arg enable_bev_pipeline)" />
    <arg name="enable_bev_pipeline" value="$(arg enable_bev_pipeline)" />

  </include>

  <!-- 3.5) UI: camera, shutdown, UDP goal bridge, path visualization -->
  <include file="$(find carla_multi_vehicle_planner)/launch/ui.launch">
    <arg name="num_vehicles" value="$(arg num_vehicles)" />
    <!-- Optionally override:
         <arg name="udp_ip" value="0.0.0.0" />
         <arg name="udp_port" value="9001" />
    -->
  </include>

  <!-- 3.6) Send enable_platooning mode to CARLA via UDP on start -->
  <node pkg="carla_multi_vehicle_planner" type="ui_mode_sender.py" name="ui_mode_sender" output="screen">
    <param name="enable_platooning" value="$(arg enable_platooning)" />
    <param name="udp_host" value="127.0.0.1" />
    <param name="udp_port" value="9002" />
    <param name="repeat_count" value="3" />
    <param name="repeat_delay" value="0.1" />
  </node>

  <!-- 4) UDP Ackermann senders to real cars (role -> IP mapping kept in that launch) -->
  <include file="$(find carla_multi_vehicle_planner)/launch/udp_ackermann_senders.launch">
    <arg name="num_vehicles" value="$(arg num_vehicles)" />
    <arg name="vehicle_1_color" value="$(arg vehicle_1_color)" />
    <arg name="vehicle_2_color" value="$(arg vehicle_2_color)" />
    <arg name="vehicle_3_color" value="$(arg vehicle_3_color)" />
    <arg name="vehicle_4_color" value="$(arg vehicle_4_color)" />
    <arg name="vehicle_5_color" value="$(arg vehicle_5_color)" />
    <arg name="vehicle_6_color" value="$(arg vehicle_6_color)" />
  </include>
</launch>


