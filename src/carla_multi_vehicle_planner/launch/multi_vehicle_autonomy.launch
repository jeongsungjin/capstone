<launch>
  <arg name="num_vehicles" default="4" />
  <arg name="include_collision_avoidance" default="false" />

  <group unless="$(arg include_collision_avoidance)">
    <node pkg="carla_multi_vehicle_planner" type="multi_vehicle_spawner.py" name="multi_vehicle_spawner" output="screen">
      <param name="num_vehicles" value="$(arg num_vehicles)" />
      <param name="enable_autopilot" value="false" />
      <param name="vehicle_model" value="vehicle.vehicle.coloredxycar" />
      <param name="target_speed" value="10.0" />
      <!-- Reset CARLA world (and actor ID counter) at startup -->
      <param name="reset_world_on_start" value="true" />
      <!-- Reset CARLA world on shutdown so IDs start from 1 next run -->
      <param name="reset_world_on_shutdown" value="true" />
    </node>

    <node pkg="carla_multi_vehicle_planner" type="networkx_path_planner.py" name="networkx_path_planner" output="screen">
      <env name="PYTHONPATH" value="$(find carla_multi_vehicle_planner)/scripts:$(optenv PYTHONPATH)" />
      <param name="num_vehicles" value="$(arg num_vehicles)" />
      <!-- Smaller map -> denser graph but shorter routes -->
      <param name="graph_resolution" value="0.25" />
      <param name="path_sampling" value="0.5" />
      <param name="min_destination_distance" value="20.0" />
      <param name="max_destination_distance" value="120.0" />
      <param name="override_preempt_min_dist" value="2.0" />
      <param name="destination_retry_limit" value="80" />
    </node>

    <node pkg="carla_multi_vehicle_planner" type="multi_vehicle_controller.py" name="multi_vehicle_controller" output="screen">
      <param name="num_vehicles" value="$(arg num_vehicles)" />
      <!-- Shorter lookahead for smaller map, keep speed moderate -->
      <param name="lookahead_distance" value="4.0" />
      <param name="target_speed" value="10.0" />
    </node>
  </group>

  <!-- UDP bridge for external vehicle selection and goal clicks -->
  <node pkg="carla_multi_vehicle_planner" type="udp_recv.py" name="udp_goal_bridge" output="screen">
    <param name="udp_ip" value="0.0.0.0" />
    <param name="udp_port" value="9001" />
  </node>

  <include if="$(arg include_collision_avoidance)" file="$(find carla_multi_vehicle_planner)/launch/predictive_collision_avoidance.launch">
    <arg name="num_vehicles" value="$(arg num_vehicles)" />
  </include>

  <node pkg="carla_multi_vehicle_planner" type="bev_visualizer.py" name="bev_visualizer" output="screen">
    <param name="max_vehicle_count" value="6" />
    <param name="update_rate" value="2.0" />
  </node>

  <!-- Spectator camera manager (follows selection and goals, then reverts to BEV) -->
  <node pkg="carla_multi_vehicle_planner" type="cam_perspective.py" name="cam_perspective" output="screen">
    <param name="num_vehicles" value="$(arg num_vehicles)" />
    <param name="spectator_auto_height" value="false" />
    <param name="spectator_height" value="65.0" />
    <param name="spectator_yaw_deg" value="-90.0" />
    <param name="spectator_pitch_deg" value="-50.0" />
    <param name="spectator_offset_x" value="-16.0" />
    <param name="spectator_offset_y" value="35.0" />
    <param name="lock_rate_hz" value="5.0" />
    <param name="follow_duration_s" value="2.0" />
    <param name="follow_back_m" value="10.0" />
    <param name="follow_up_m" value="8.0" />
    <param name="follow_right_m" value="-4.0" />
    <param name="goal_duration_s" value="2.0" />
    <param name="goal_height" value="5.0" />
    <param name="goal_yaw_deg" value="-90.0" />
    <param name="goal_pitch_deg" value="-0.0" />
    <param name="goal_match_tolerance" value="3.0" />
    <param name="goal1_yaw_deg" value="180.0" />
    <param name="goal2_yaw_deg" value="0.0" />
    <param name="goal3_yaw_deg" value="-90.0" />
    <param name="goal4_yaw_deg" value="-90.0" />
    <param name="goal5_yaw_deg" value="-90.0" />
    <!-- Optional per-destination camera overrides (enable and set coordinates/angles) -->
    <param name="goal1_use_cam" value="True" />
    <param name="goal1_cam_x" value="-33.210" />
    <param name="goal1_cam_y" value="-43.790" />
    <param name="goal1_cam_z" value="20.0" />
    <param name="goal1_cam_yaw_deg" value="180.0" />
    <param name="goal1_cam_pitch_deg" value="-30.0" />
    <param name="goal2_use_cam" value="True" />
    <param name="goal2_cam_x" value="36.780" />
    <param name="goal2_cam_y" value="-43.670" />
    <param name="goal2_cam_z" value="20.0" />
    <param name="goal2_cam_yaw_deg" value="0.0" />
    <param name="goal2_cam_pitch_deg" value="-30.0" />
    <param name="goal3_use_cam" value="True" />
    <param name="goal3_cam_x" value="-44.70" />
    <param name="goal3_cam_y" value="8.24" />
    <param name="goal3_cam_z" value="20.0" />
    <param name="goal3_cam_yaw_deg" value="-90.0" />
    <param name="goal3_cam_pitch_deg" value="-40.0" />
    <param name="goal4_use_cam" value="True" />
    <param name="goal4_cam_x" value="45.750" />
    <param name="goal4_cam_y" value="7.520" />
    <param name="goal4_cam_z" value="20.0" />
    <param name="goal4_cam_yaw_deg" value="-90.0" />
    <param name="goal4_cam_pitch_deg" value="-50.0" />
    <param name="goal5_use_cam" value="True" />
    <param name="goal5_cam_x" value="8.06" />
    <param name="goal5_cam_y" value="-15.820" />
    <param name="goal5_cam_z" value="10.0" />
    <param name="goal5_cam_yaw_deg" value="-90.0" />
    <param name="goal5_cam_pitch_deg" value="-30.0" />
  </node>
</launch>