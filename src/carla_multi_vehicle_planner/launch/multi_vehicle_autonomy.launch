<launch>
  <arg name="num_vehicles" default="4" />
  <arg name="include_collision_avoidance" default="false" />

  <group unless="$(arg include_collision_avoidance)">
    <node pkg="carla_multi_vehicle_planner" type="multi_vehicle_spawner.py" name="multi_vehicle_spawner" output="screen">
      <param name="num_vehicles" value="$(arg num_vehicles)" />
      <param name="enable_autopilot" value="false" />
      <param name="vehicle_model" value="vehicle.vehicle.coloredxycar" />
      <param name="target_speed" value="10.0" />
    </node>

    <node pkg="carla_multi_vehicle_planner" type="networkx_path_planner.py" name="networkx_path_planner" output="screen">
      <env name="PYTHONPATH" value="$(find carla_multi_vehicle_planner)/scripts:$(optenv PYTHONPATH)" />
      <param name="num_vehicles" value="$(arg num_vehicles)" />
      <!-- Smaller map -> denser graph but shorter routes -->
      <param name="graph_resolution" value="0.25" />
      <param name="path_sampling" value="0.5" />
      <param name="min_destination_distance" value="20.0" />
      <param name="max_destination_distance" value="120.0" />
      <param name="override_preempt_min_dist" value="2.0" />
      <param name="destination_retry_limit" value="80" />
    </node>

    <node pkg="carla_multi_vehicle_planner" type="multi_vehicle_controller.py" name="multi_vehicle_controller" output="screen">
      <param name="num_vehicles" value="$(arg num_vehicles)" />
      <!-- Shorter lookahead for smaller map, keep speed moderate -->
      <param name="lookahead_distance" value="4.0" />
      <param name="target_speed" value="10.0" />
    </node>
  </group>

  <!-- UDP bridge for external vehicle selection and goal clicks -->
  <node pkg="carla_multi_vehicle_planner" type="udp_recv.py" name="udp_goal_bridge" output="screen">
    <param name="udp_ip" value="0.0.0.0" />
    <param name="udp_port" value="9001" />
  </node>

  <!-- predictive_collision_avoidance removed -->

  <node pkg="carla_multi_vehicle_planner" type="bev_visualizer.py" name="bev_visualizer" output="screen">
    <param name="max_vehicle_count" value="6" />
    <param name="update_rate" value="2.0" />
  </node>

  <!-- Spectator camera manager (follows selection and goals, then reverts to BEV) -->
  <node pkg="carla_multi_vehicle_planner" type="cam_perspective.py" name="cam_perspective" output="screen">
    <param name="num_vehicles" value="$(arg num_vehicles)" />
  </node>

  <!-- Draw re-planned paths in CARLA for 10s only when override click triggered -->
  <node pkg="carla_multi_vehicle_planner" type="path_visualization.py" name="path_visualization" output="screen">
    <param name="num_vehicles" value="$(arg num_vehicles)" />
    <param name="life_time" value="10.0" />
    <param name="override_to_path_window" value="3.0" />
  </node>

  <!-- Dedicated shutdown/reset node (reload CARLA world on ROS shutdown) -->
  <node pkg="carla_multi_vehicle_planner" type="carla_shutdown.py" name="carla_shutdown" output="screen">
    <param name="reset_world_on_shutdown" value="true" />
  </node>
</launch>